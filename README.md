# wsl2-auto-modules
Automatic WSL2 modules prepare download headers, create module example and compile.
WSL2 Auto Modules: Kernel Module BuilderTable of ContentsIntroductionFeaturesPrerequisitesHow to Use the ScriptGetting StartedMain Menu OptionsProject StructureCommon Issues and TroubleshootingCompatibility and ConsiderationsContributingLicenseContactIntroductionThis repository provides a comprehensive Bash script designed to simplify the process of building and managing custom Linux kernel modules within the Windows Subsystem for Linux 2 (WSL2) environment. Specifically tailored for Ubuntu and Debian distributions running on WSL2, this interactive script automates complex tasks such as installing build dependencies, preparing the WSL2-specific kernel source code, creating module files, compiling, testing, and integrating with DKMS (Dynamic Kernel Module Support) for persistence across kernel updates.The standard WSL2 kernel, like 6.6.87.2-microsoft-standard-WSL2, is optimized by Microsoft but may lack specific functionalities or drivers required for niche use cases (e.g., Waydroid, Open vSwitch). This script offers a streamlined, less intrusive alternative to compiling an entire custom kernel, allowing users to extend kernel functionality by adding out-of-tree modules seamlessly.FeaturesInteractive TUI-like Interface: Guides the user through each step with clear prompts and color-coded output.Automated Prerequisite Installation: Installs essential build tools and libraries for kernel module development.WSL2 Kernel Source Preparation: Automatically detects the running WSL2 kernel version, clones the official Microsoft WSL2-Linux-Kernel repository, checks out the correct tag, extracts the current kernel configuration, and prepares the source tree for module compilation.Custom Module Creation: Generates a basic "Hello World" kernel module C source file and its corresponding Makefile, adaptable for custom module names.Module Compilation and Testing: Automates the compilation process and provides interactive steps to load (insmod), verify (lsmod, dmesg), and unload (rmmod) the module.DKMS Integration for Persistence: Configures DKMS to ensure your custom module is automatically recompiled and reinstalled after WSL2 kernel updates, maintaining functionality without manual intervention.Boot-time Autoloading: Option to configure the module to load automatically upon WSL2 startup.Compatibility Checks: Verifies OS compatibility (Ubuntu/Debian) before proceeding.Guided Troubleshooting: Provides insights into common issues like "kernel headers not found" errors, specifically addressing WSL2 peculiarities.PrerequisitesBefore running the script, ensure you have:A WSL2 instance running Ubuntu or Debian.Internet connectivity for downloading packages and cloning the kernel repository.sudo privileges within your WSL2 distribution.The script will guide you through installing the necessary build tools (e.g., build-essential, git, dkms, flex, bison, libssl-dev, libelf-dev, libncurses-dev, bc, cpio, qemu-utils).How to Use the ScriptGetting StartedClone the Repository:git clone https://github.com/rluf/wsl2-auto-modules.git
cd wsl2-auto-modules
Make the Script Executable:chmod +x wsl2_module_builder.sh
Run the Script:./wsl2_module_builder.sh
Main Menu OptionsThe script will present an interactive menu:Check OS Compatibility: Verifies if your WSL2 distribution is Ubuntu or Debian.Install Prerequisites: Installs all necessary build tools and libraries. Highly recommended to run this first.Prepare Kernel Source:Automatically detects your current WSL2 kernel version.Clones the microsoft/WSL2-Linux-Kernel repository.Checks out the appropriate kernel tag (e.g., linux-msft-wsl-6.6.87.2).Extracts your running kernel's configuration (/proc/config.gz) to .config.Runs make prepare modules_prepare to set up the kernel source for external module compilation.You will be asked to confirm the path to the kernel source (default: ~/src/kernel/WSL2-Linux-Kernel).Create Module Files:Prompts you to enter a name for your custom module (default: hello-wsl2-module).Generates a basic C source file (<module_name>.c) and a Makefile for your module.These files will be saved in a new directory, e.g., ~/hello-wsl2-module_module/.Note: Direct LLM integration for module description generation is not supported in this Bash script. A default description will be used.Compile and Test Module:Navigates to your module's directory.Executes make to compile your module into a .ko file.Provides options to load (sudo insmod), check (lsmod, dmesg), and unload (sudo rmmod) the module for testing.Integrate with DKMS for Persistence:Generates the dkms.conf file for your module.Copies your module's source to /usr/src/<module_name>-<version>.Adds, builds, and installs your module using DKMS commands (sudo dkms add, sudo dkms build, sudo dkms install).Provides an option to configure the module for automatic loading at boot time.Final Considerations and Compatibility:Provides important notes on compatibility with Docker Desktop and GPU passthrough.Explains how to use the .wslconfig file in Windows for advanced kernel arguments (e.g., module.sig_unenforce).Exit: Exits the script.Follow the on-screen prompts and confirmations to navigate through the process.Project Structure.
├── LICENSE
├── README.md
└── wsl2_module_builder.sh
Common Issues and Troubleshooting"Error! Your kernel headers for kernel X.X.X-microsoft-standard-WSL2 cannot be found...":This is common because standard apt repositories don't provide headers for Microsoft's WSL2 kernels.Solution: Ensure you've run Step 3: Prepare Kernel Source successfully. The script handles cloning the correct Microsoft kernel source, extracting /proc/config.gz, and running make prepare modules_prepare. Verify that the KERNEL_SOURCE_PATH in your module's Makefile and dkms.conf (if using DKMS) points to this prepared source tree.Compilation failures (e.g., "No rule to make target...", "undeclared function"):Solution:Double-check your module's C code for syntax errors.Ensure all prerequisites (Step 2) are installed.Verify that the KERNEL_SOURCE_PATH in your module's Makefile is correct and the kernel source has been properly prepared (Step 3).Review the output of make carefully for specific error messages.Module fails to load (insmod: ERROR: could not insert ...: Operation not permitted):This might indicate a module signature verification issue.Solution: You might need to disable module signature enforcement by adding kernelCommandLine = module.sig_unenforce to your Windows .wslconfig file (located at %UserProfile%\.wslconfig). Remember to wsl --shutdown and restart WSL after modifying .wslconfig.Compatibility and ConsiderationsDocker Desktop & GPU: Using custom kernels or modules with Docker Desktop on WSL2 is not officially supported and may cause issues. Proceed with caution. Ensure your module does not interfere with existing GPU drivers or configurations if you rely on GPU acceleration.Kernel Updates: DKMS is crucial for maintaining module functionality across WSL2 kernel updates. Without it, you would need to manually recompile and reinstall your module after each update.Custom Kernels vs. Modules: This script focuses on modules, which extend an existing kernel. Compiling a full custom kernel is a more involved process that replaces the entire kernel image and requires modifying .wslconfig.ContributingContributions are welcome! If you find a bug, have a feature request, or want to improve the script, please open an issue or submit a pull request on GitHub.LicenseThis project is licensed under the MIT License - see the LICENSE file for details.ContactAuthor: Roger LuftEmail: roger@webstorge.com.brGitHub: rluf/wsl2-auto-modulesWSL2 Auto Modules: Construtor de Módulos de KernelSumárioIntroduçãoRecursosPré-requisitosComo Usar o ScriptPrimeiros PassosOpções do Menu PrincipalEstrutura do ProjetoProblemas Comuns e Solução de ProblemasCompatibilidade e ConsideraçõesContribuindoLicençaContatoIntroduçãoEste repositório fornece um script Bash abrangente projetado para simplificar o processo de construção e gerenciamento de módulos de kernel Linux personalizados dentro do ambiente Windows Subsystem for Linux 2 (WSL2). Adaptado especificamente para distribuições Ubuntu e Debian executando no WSL2, este script interativo automatiza tarefas complexas como a instalação de dependências de construção, a preparação do código-fonte do kernel específico do WSL2, a criação de arquivos de módulo, a compilação, o teste e a integração com DKMS (Dynamic Kernel Module Support) para persistência em atualizações de kernel.O kernel padrão do WSL2, como o 6.6.87.2-microsoft-standard-WSL2, é otimizado pela Microsoft, mas pode não possuir funcionalidades ou drivers específicos exigidos para casos de uso de nicho (por exemplo, Waydroid, Open vSwitch). Este script oferece uma alternativa simplificada e menos intrusiva à compilação de um kernel personalizado completo, permitindo que os usuários estendam a funcionalidade do kernel adicionando módulos "fora da árvore" de forma contínua.RecursosInterface Interativa Semelhante a TUI: Guia o usuário por cada etapa com avisos claros e saída colorida.Instalação Automatizada de Pré-requisitos: Instala as ferramentas de construção e bibliotecas essenciais para o desenvolvimento de módulos de kernel.Preparação do Código-Fonte do Kernel WSL2: Detecta automaticamente a versão do kernel WSL2 em execução, clona o repositório oficial microsoft/WSL2-Linux-Kernel, faz o checkout da tag correta, extrai a configuração do kernel atual e prepara a árvore de código-fonte para a compilação do módulo.Criação de Módulos Personalizados: Gera um arquivo-fonte C básico de módulo "Hello World" e seu Makefile correspondente, adaptável para nomes de módulos personalizados.Compilação e Teste de Módulos: Automatiza o processo de compilação e fornece etapas interativas para carregar (insmod), verificar (lsmod, dmesg) e descarregar (rmmod) o módulo.Integração DKMS para Persistência: Configura o DKMS para garantir que seu módulo personalizado seja automaticamente recompilado e reinstalado após as atualizações do kernel WSL2, mantendo a funcionalidade sem intervenção manual.Carregamento Automático na Inicialização: Opção para configurar o módulo para carregar automaticamente na inicialização do WSL2.Verificações de Compatibilidade: Verifica a compatibilidade do SO (Ubuntu/Debian) antes de prosseguir.Solução de Problemas Guiada: Fornece insights sobre problemas comuns, como erros de "cabeçalhos do kernel não encontrados", abordando especificamente as peculiaridades do WSL2.Pré-requisitosAntes de executar o script, certifique-se de ter:Uma instância WSL2 executando Ubuntu ou Debian.Conectividade com a internet para baixar pacotes e clonar o repositório do kernel.Privilégios sudo em sua distribuição WSL2.O script irá guiá-lo na instalação das ferramentas de construção necessárias (por exemplo, build-essential, git, dkms, flex, bison, libssl-dev, libelf-dev, libncurses-dev, bc, cpio, qemu-utils).Como Usar o ScriptPrimeiros PassosClone o Repositório:git clone https://github.com/rluf/wsl2-auto-modules.git
cd wsl2-auto-modules
Torne o Script Executável:chmod +x wsl2_module_builder.sh
Execute o Script:./wsl2_module_builder.sh
Opções do Menu PrincipalO script apresentará um menu interativo:Verificar Compatibilidade do SO: Verifica se sua distribuição WSL2 é Ubuntu ou Debian.Instalar Pré-requisitos: Instala todas as ferramentas de construção e bibliotecas necessárias. Altamente recomendado executar isso primeiro.Preparar Código-Fonte do Kernel:Detecta automaticamente sua versão atual do kernel WSL2.Clona o repositório microsoft/WSL2-Linux-Kernel.Faz o checkout da tag do kernel apropriada (por exemplo, linux-msft-wsl-6.6.87.2).Extrai a configuração do kernel em execução (/proc/config.gz) para .config.Executa make prepare modules_prepare para configurar a árvore de código-fonte para a compilação de módulos externos.Você será solicitado a confirmar o caminho para o código-fonte do kernel (padrão: ~/src/kernel/WSL2-Linux-Kernel).Criar Arquivos do Módulo:Solicita que você insira um nome para seu módulo personalizado (padrão: hello-wsl2-module).Gera um arquivo-fonte C básico (<nome_do_modulo>.c) e um Makefile para seu módulo.Esses arquivos serão salvos em um novo diretório, por exemplo, ~/hello-wsl2-module_module/.Nota: A integração direta com LLM para geração de descrição de módulo não é suportada neste script Bash. Uma descrição padrão será usada.Compilar e Testar Módulo:Navega para o diretório do seu módulo.Executa make para compilar seu módulo em um arquivo .ko.Fornece opções para carregar (sudo insmod), verificar (lsmod, dmesg) e descarregar (sudo rmmod) o módulo para teste.Integrar com DKMS para Persistência:Gera o arquivo dkms.conf para seu módulo.Copia o código-fonte do seu módulo para /usr/src/<nome_do_modulo>-<versão>.Adiciona, constrói e instala seu módulo usando comandos DKMS (sudo dkms add, sudo dkms build, sudo dkms install).Fornece uma opção para configurar o módulo para carregamento automático na inicialização.Considerações Finais e Compatibilidade:Fornece notas importantes sobre compatibilidade com Docker Desktop e passagem de GPU.Explica como usar o arquivo .wslconfig no Windows para argumentos avançados do kernel (por exemplo, module.sig_unenforce).Sair: Sai do script.Siga as instruções e confirmações na tela para navegar pelo processo.Estrutura do Projeto.
├── LICENSE
├── README.md
└── wsl2_module_builder.sh
Problemas Comuns e Solução de Problemas"Error! Your kernel headers for kernel X.X.X-microsoft-standard-WSL2 cannot be found...":Isso é comum porque os repositórios apt padrão não fornecem cabeçalhos para os kernels WSL2 da Microsoft.Solução: Certifique-se de ter executado o Passo 3: Preparar Código-Fonte do Kernel com sucesso. O script lida com a clonagem do código-fonte correto do kernel da Microsoft, extraindo /proc/config.gz e executando make prepare modules_prepare. Verifique se o KERNEL_SOURCE_PATH no Makefile do seu módulo e no dkms.conf (se estiver usando DKMS) aponta para esta árvore de código-fonte preparada.Falhas de Compilação (por exemplo, "No rule to make target...", "função não declarada"):Solução:Verifique novamente o código C do seu módulo em busca de erros de sintaxe.Certifique-se de que todos os pré-requisitos (Passo 2) estejam instalados.Verifique se o KERNEL_SOURCE_PATH no Makefile do seu módulo está correto e se o código-fonte do kernel foi devidamente preparado (Passo 3).Revise cuidadosamente a saída do make para mensagens de erro específicas.O módulo falha ao carregar (insmod: ERROR: could not insert ...: Operation not permitted):Isso pode indicar um problema de verificação de assinatura de módulo.Solução: Pode ser necessário desabilitar a imposição de assinatura de módulo adicionando kernelCommandLine = module.sig_unenforce ao seu arquivo .wslconfig do Windows (localizado em %UserProfile%\.wslconfig). Lembre-se de wsl --shutdown e reiniciar o WSL após modificar o .wslconfig.Compatibilidade e ConsideraçõesDocker Desktop e GPU: O uso de kernels ou módulos personalizados com o Docker Desktop no WSL2 não é oficialmente suportado e pode causar problemas. Prossiga com cautela. Certifique-se de que seu módulo não interfira com os drivers ou configurações de GPU existentes se você depender da aceleração de GPU.Atualizações do Kernel: O DKMS é crucial para manter a funcionalidade do módulo em todas as atualizações do kernel WSL2. Sem ele, você precisaria recompilar e reinstalar manualmente seu módulo após cada atualização.Kernels Personalizados vs. Módulos: Este script se concentra em módulos, que estendem um kernel existente. A compilação de um kernel personalizado completo é um processo mais envolvido que substitui toda a imagem do kernel e requer a modificação do .wslconfig.ContribuindoContribuições são bem-vindas! Se você encontrar um bug, tiver uma solicitação de recurso ou quiser melhorar o script, abra uma issue ou envie um pull request no GitHub.LicençaEste projeto está licenciado sob a Licença MIT - consulte o arquivo LICENSE para obter detalhes.ContatoAutor: Roger LuftEmail: roger@webstorge.com.brGitHub: rluf/wsl2-auto-modules
